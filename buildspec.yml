version: 0.2

# AWS CodeBuild 构建规范文件
# 用于定义构建过程的各个阶段

env:
  variables:
    # 可以在这里定义环境变量
    GO_VERSION: "1.21"
  parameter-store:
    # 从AWS Systems Manager Parameter Store获取敏感信息
    # DOCKER_USERNAME: /myapp/docker/username
    # DOCKER_PASSWORD: /myapp/docker/password
  secrets-manager:
    # 从AWS Secrets Manager获取密钥
    # DOCKER_CREDENTIALS: myapp/docker:credentials

phases:
  install:
    # 安装阶段
    runtime-versions:
      golang: 1.21
    commands:
      - echo "Installing dependencies..."
      - go version

  pre_build:
    # 构建前阶段 - 运行测试
    commands:
      - echo "Running tests..."
      - go test -v ./...
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com

  build:
    # 构建阶段 - 构建Docker镜像
    commands:
      - echo "Build started on $(date)"
      - echo "Building the Docker image..."
      - docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG .
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:latest

  post_build:
    # 构建后阶段 - 推送镜像
    commands:
      - echo "Build completed on $(date)"
      - echo "Pushing the Docker images..."
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:latest
      - echo "Writing image definitions file..."
      - printf '[{"name":"%s","imageUri":"%s"}]' $CONTAINER_NAME $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG > imagedefinitions.json

artifacts:
  # 构建产物
  files:
    - imagedefinitions.json
    - appspec.yml
  name: BuildArtifact

cache:
  # 缓存Go模块以加速构建
  paths:
    - '/go/pkg/mod/**/*'
